<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ê°€ìƒ ì£¼ì‹ ê±°ë˜ ì‹œìŠ¤í…œ ERD (ê¸°ë³¸)</title>
    <script src="https://cdn.jsdelivr.net/npm/mermaid/dist/mermaid.min.js"></script>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
        }
        h1 {
            text-align: center;
            color: #333;
            margin-bottom: 10px;
            font-size: 32px;
        }
        .subtitle {
            text-align: center;
            color: #666;
            margin-bottom: 30px;
            font-size: 16px;
        }
        .badge {
            display: inline-block;
            padding: 5px 15px;
            background: #667eea;
            color: white;
            border-radius: 20px;
            font-size: 12px;
            margin: 0 5px;
        }
        .info-box {
            background: #f8f9fa;
            border-left: 4px solid #667eea;
            padding: 15px;
            margin: 20px 0;
            border-radius: 5px;
        }
        .info-box h3 {
            margin-top: 0;
            color: #667eea;
        }
        .legend {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin: 20px 0;
            flex-wrap: wrap;
        }
        .legend-item {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 15px;
            background: #f8f9fa;
            border-radius: 8px;
        }
        .legend-symbol {
            font-weight: bold;
            color: #667eea;
        }
        #erd-container {
            background: white;
            padding: 20px;
            border-radius: 10px;
            overflow-x: auto;
        }
        .mermaid {
            display: flex;
            justify-content: center;
        }
        .note {
            background: #fff3cd;
            border: 1px solid #ffc107;
            padding: 15px;
            border-radius: 8px;
            margin-top: 20px;
        }
        .note strong {
            color: #856404;
        }
        pre {
            background: #f5f5f5;
            padding: 15px;
            border-radius: 5px;
            overflow-x: auto;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ¦ ê°€ìƒ ì£¼ì‹ ê±°ë˜ ì‹œìŠ¤í…œ (ê¸°ë³¸)</h1>
        <div class="subtitle">
            <span class="badge">ê´€ê³„í˜• ë°ì´í„°ë² ì´ìŠ¤</span>
            <span class="badge">ERD</span>
            <span class="badge">ê¸°ë³¸ 4ê°œ í…Œì´ë¸”</span>
        </div>

        <div class="info-box">
            <h3>ğŸ“Š ë°ì´í„°ë² ì´ìŠ¤ ê°œìš”</h3>
            <ul>
                <li><strong>ë°ì´í„°ë² ì´ìŠ¤ëª…:</strong> stock_trading</li>
                <li><strong>í…Œì´ë¸” ìˆ˜:</strong> 4ê°œ (users, portfolios, transactions, stock_cache)</li>
                <li><strong>ì£¼ìš” ê¸°ëŠ¥:</strong> ì‚¬ìš©ì ê´€ë¦¬, í¬íŠ¸í´ë¦¬ì˜¤ ê´€ë¦¬, ê±°ë˜ ë‚´ì—­ ì¶”ì , ì£¼ì‹ ê°€ê²© ìºì‹±</li>
            </ul>
        </div>

        <div class="legend">
            <div class="legend-item">
                <span class="legend-symbol">PK</span>
                <span>Primary Key (ê¸°ë³¸í‚¤)</span>
            </div>
            <div class="legend-item">
                <span class="legend-symbol">FK</span>
                <span>Foreign Key (ì™¸ë˜í‚¤)</span>
            </div>
            <div class="legend-item">
                <span class="legend-symbol">UK</span>
                <span>Unique Key (ê³ ìœ í‚¤)</span>
            </div>
            <div class="legend-item">
                <span class="legend-symbol">1:N</span>
                <span>One to Many (ì¼ëŒ€ë‹¤ ê´€ê³„)</span>
            </div>
        </div>

        <div id="erd-container">
            <div class="mermaid">
erDiagram
    USERS ||--o{ PORTFOLIOS : "ë³´ìœ "
    USERS ||--o{ TRANSACTIONS : "ê±°ë˜"
    
    USERS {
        bigint id PK "ì‚¬ìš©ì ID"
        varchar username UK "ì‚¬ìš©ìëª… (ê³ ìœ )"
        varchar email UK "ì´ë©”ì¼ (ê³ ìœ )"
        varchar password "ì•”í˜¸í™”ëœ ë¹„ë°€ë²ˆí˜¸"
        decimal balance "ë³´ìœ  í˜„ê¸ˆ (KRW)"
        timestamp created_at "ìƒì„±ì¼ì‹œ"
        timestamp updated_at "ìˆ˜ì •ì¼ì‹œ"
    }
    
    PORTFOLIOS {
        bigint id PK "í¬íŠ¸í´ë¦¬ì˜¤ ID"
        bigint user_id FK "ì‚¬ìš©ì ID"
        varchar symbol "ì£¼ì‹ ì‹¬ë³¼"
        int quantity "ë³´ìœ  ìˆ˜ëŸ‰"
        decimal avg_price "í‰ê·  ë§¤ìˆ˜ê°€ (KRW)"
        varchar market "ì‹œì¥ (KRW/USD)"
        timestamp created_at "ìµœì´ˆ ë§¤ìˆ˜ì¼"
        timestamp updated_at "ë§ˆì§€ë§‰ ìˆ˜ì •ì¼"
    }
    
    TRANSACTIONS {
        bigint id PK "ê±°ë˜ ID"
        bigint user_id FK "ì‚¬ìš©ì ID"
        varchar symbol "ì£¼ì‹ ì‹¬ë³¼"
        varchar type "ê±°ë˜ ìœ í˜• (buy/sell)"
        int quantity "ê±°ë˜ ìˆ˜ëŸ‰"
        decimal price "ê±°ë˜ ë‹¨ê°€ (KRW)"
        decimal commission "ê±°ë˜ ìˆ˜ìˆ˜ë£Œ"
        decimal total_amount "ì´ ê±°ë˜ê¸ˆì•¡"
        varchar market "ì‹œì¥ (KRW/USD)"
        timestamp timestamp "ê±°ë˜ ì‹œê°"
    }
    
    STOCK_CACHE {
        bigint id PK "ìºì‹œ ID"
        varchar symbol UK "ì£¼ì‹ ì‹¬ë³¼ (ê³ ìœ )"
        varchar name "íšŒì‚¬ëª…"
        decimal current_price "í˜„ì¬ê°€"
        decimal previous_close "ì „ì¼ ì¢…ê°€"
        decimal open_price "ì‹œê°€"
        decimal high_price "ê³ ê°€"
        decimal low_price "ì €ê°€"
        bigint volume "ê±°ë˜ëŸ‰"
        decimal change "ê°€ê²© ë³€ë™"
        decimal change_percent "ë³€ë™ë¥  (%)"
        varchar market "ì‹œì¥ (KRW/USD)"
        varchar currency "í†µí™”"
        decimal exchange_rate "í™˜ìœ¨ (USDë§Œ)"
        timestamp updated_at "ì—…ë°ì´íŠ¸ ì‹œê°"
    }
            </div>
        </div>

        <div class="info-box">
            <h3>ğŸ”— í…Œì´ë¸” ê´€ê³„ ì„¤ëª…</h3>
            <ul>
                <li><strong>USERS â†” PORTFOLIOS (1:N)</strong>
                    <br>â†’ í•œ ì‚¬ìš©ìëŠ” ì—¬ëŸ¬ ì£¼ì‹ì„ ë³´ìœ í•  ìˆ˜ ìˆìŒ
                    <br>â†’ portfolios.user_idê°€ users.idë¥¼ ì°¸ì¡°
                </li>
                <li><strong>USERS â†” TRANSACTIONS (1:N)</strong>
                    <br>â†’ í•œ ì‚¬ìš©ìëŠ” ì—¬ëŸ¬ ê±°ë˜ ë‚´ì—­ì„ ê°€ì§ˆ ìˆ˜ ìˆìŒ
                    <br>â†’ transactions.user_idê°€ users.idë¥¼ ì°¸ì¡°
                </li>
                <li><strong>STOCK_CACHE (ë…ë¦½)</strong>
                    <br>â†’ ë‹¤ë¥¸ í…Œì´ë¸”ê³¼ ê´€ê³„ ì—†ì´ ë…ë¦½ì ìœ¼ë¡œ ì¡´ì¬
                    <br>â†’ ì£¼ì‹ ê°€ê²© ì •ë³´ë¥¼ ìºì‹±í•˜ì—¬ API í˜¸ì¶œ ìµœì†Œí™”
                </li>
            </ul>
        </div>

        <div class="info-box">
            <h3>ğŸ“‹ CREATE TABLE ìŠ¤í¬ë¦½íŠ¸</h3>
            <pre>
-- 1. USERS (ì‚¬ìš©ì)
CREATE TABLE users (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    username VARCHAR(50) NOT NULL,
    email VARCHAR(100) NOT NULL,
    password VARCHAR(255) NOT NULL,
    balance DECIMAL(15,2) NOT NULL DEFAULT 1000000.00,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    UNIQUE KEY uk_email (email),
    UNIQUE KEY uk_username (username)
);

-- 2. PORTFOLIOS (í¬íŠ¸í´ë¦¬ì˜¤)
CREATE TABLE portfolios (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    user_id BIGINT NOT NULL,
    symbol VARCHAR(20) NOT NULL,
    quantity INT NOT NULL CHECK (quantity > 0),
    avg_price DECIMAL(15,2) NOT NULL,
    market VARCHAR(10) NOT NULL,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE CASCADE,
    UNIQUE KEY uk_user_symbol (user_id, symbol)
);

-- 3. TRANSACTIONS (ê±°ë˜ ë‚´ì—­)
CREATE TABLE transactions (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    user_id BIGINT NOT NULL,
    symbol VARCHAR(20) NOT NULL,
    type VARCHAR(10) NOT NULL CHECK (type IN ('buy', 'sell')),
    quantity INT NOT NULL,
    price DECIMAL(15,2) NOT NULL,
    commission DECIMAL(15,2) NOT NULL,
    total_amount DECIMAL(15,2) NOT NULL,
    market VARCHAR(10) NOT NULL,
    timestamp TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE CASCADE
);

-- 4. STOCK_CACHE (ì£¼ì‹ ìºì‹œ)
CREATE TABLE stock_cache (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    symbol VARCHAR(20) NOT NULL,
    name VARCHAR(200),
    current_price DECIMAL(15,2) NOT NULL,
    previous_close DECIMAL(15,2),
    open_price DECIMAL(15,2),
    high_price DECIMAL(15,2),
    low_price DECIMAL(15,2),
    volume BIGINT,
    change DECIMAL(15,2),
    change_percent DECIMAL(10,4),
    market VARCHAR(10),
    currency VARCHAR(10),
    exchange_rate DECIMAL(10,4),
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    UNIQUE KEY uk_symbol (symbol)
);
            </pre>
        </div>

        <div class="info-box">
            <h3>ğŸ“‹ ì¸ë±ìŠ¤ ê¶Œì¥ì‚¬í•­</h3>
            <pre>
-- USERS í…Œì´ë¸”
CREATE UNIQUE INDEX idx_users_email ON users(email);
CREATE UNIQUE INDEX idx_users_username ON users(username);

-- PORTFOLIOS í…Œì´ë¸”
CREATE UNIQUE INDEX idx_portfolios_user_symbol ON portfolios(user_id, symbol);
CREATE INDEX idx_portfolios_user_id ON portfolios(user_id);
CREATE INDEX idx_portfolios_symbol ON portfolios(symbol);

-- TRANSACTIONS í…Œì´ë¸”
CREATE INDEX idx_transactions_user_id ON transactions(user_id);
CREATE INDEX idx_transactions_symbol ON transactions(symbol);
CREATE INDEX idx_transactions_timestamp ON transactions(timestamp DESC);
CREATE INDEX idx_transactions_user_timestamp ON transactions(user_id, timestamp DESC);

-- STOCK_CACHE í…Œì´ë¸”
CREATE UNIQUE INDEX idx_stock_cache_symbol ON stock_cache(symbol);
CREATE INDEX idx_stock_cache_updated_at ON stock_cache(updated_at DESC);
            </pre>
        </div>

        <div class="info-box">
            <h3>ğŸ’¾ ë°ì´í„° íƒ€ì… ì •ì˜ (PostgreSQL/MySQL)</h3>
            <ul>
                <li><strong>bigint:</strong> í° ì •ìˆ˜ (ID ê°’)</li>
                <li><strong>varchar:</strong> ê°€ë³€ ê¸¸ì´ ë¬¸ìì—´</li>
                <li><strong>decimal:</strong> ì •í™•í•œ ì†Œìˆ˜ì  ê³„ì‚° (ê¸ˆì•¡, ê°€ê²©)</li>
                <li><strong>int:</strong> ì •ìˆ˜ (ìˆ˜ëŸ‰)</li>
                <li><strong>timestamp:</strong> ë‚ ì§œì™€ ì‹œê°„</li>
            </ul>
        </div>

        <div class="note">
            <strong>âš ï¸ ì°¸ê³ :</strong> ì‹¤ì œ êµ¬í˜„ì€ MongoDB (NoSQL)ë¥¼ ì‚¬ìš©í•˜ê³  ìˆìŠµë‹ˆë‹¤. 
            ì´ ERDëŠ” ê´€ê³„í˜• ë°ì´í„°ë² ì´ìŠ¤ë¡œ ë§ˆì´ê·¸ë ˆì´ì…˜í•  ê²½ìš°ë¥¼ ê°€ì •í•œ ì„¤ê³„ì…ë‹ˆë‹¤.
        </div>

        <div class="info-box">
            <h3>ğŸ”„ ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ íë¦„</h3>
            <h4>1ï¸âƒ£ íšŒì›ê°€ì…</h4>
            <pre>INSERT INTO users (username, email, password, balance) 
VALUES ('í™ê¸¸ë™', 'hong@example.com', 'hashed_pwd', 1000000);</pre>
            
            <h4>2ï¸âƒ£ ì£¼ì‹ ë§¤ìˆ˜</h4>
            <pre>-- 1. í¬íŠ¸í´ë¦¬ì˜¤ì— ì¶”ê°€/ì—…ë°ì´íŠ¸
INSERT INTO portfolios (user_id, symbol, quantity, avg_price, market)
VALUES (1, '005930', 10, 70000, 'KRW')
ON CONFLICT (user_id, symbol) 
DO UPDATE SET quantity = portfolios.quantity + 10;

-- 2. ê±°ë˜ ë‚´ì—­ ê¸°ë¡
INSERT INTO transactions (user_id, symbol, type, quantity, price, commission, total_amount, market)
VALUES (1, '005930', 'buy', 10, 70000, 1050, 701050, 'KRW');

-- 3. ì”ì•¡ ì°¨ê°
UPDATE users SET balance = balance - 701050 WHERE id = 1;</pre>

            <h4>3ï¸âƒ£ ì£¼ì‹ ë§¤ë„</h4>
            <pre>-- 1. í¬íŠ¸í´ë¦¬ì˜¤ ìˆ˜ëŸ‰ ê°ì†Œ
UPDATE portfolios 
SET quantity = quantity - 5 
WHERE user_id = 1 AND symbol = '005930';

-- 2. ê±°ë˜ ë‚´ì—­ ê¸°ë¡
INSERT INTO transactions (user_id, symbol, type, quantity, price, commission, total_amount, market)
VALUES (1, '005930', 'sell', 5, 71000, 532, 354468, 'KRW');

-- 3. ì”ì•¡ ì¦ê°€
UPDATE users SET balance = balance + 354468 WHERE id = 1;</pre>
        </div>

        <div class="info-box">
            <h3>ğŸ“Š ì£¼ìš” ì¿¼ë¦¬ ì˜ˆì‹œ</h3>
            
            <h4>ì‚¬ìš©ìë³„ í¬íŠ¸í´ë¦¬ì˜¤ ì¡°íšŒ</h4>
            <pre>
SELECT 
    p.symbol,
    p.quantity,
    p.avg_price,
    s.name,
    s.current_price,
    (s.current_price - p.avg_price) * p.quantity AS profit_loss,
    ((s.current_price - p.avg_price) / p.avg_price * 100) AS profit_loss_percent
FROM portfolios p
JOIN stock_cache s ON p.symbol = s.symbol
WHERE p.user_id = 1;
            </pre>

            <h4>ê±°ë˜ ë‚´ì—­ ì¡°íšŒ</h4>
            <pre>
SELECT 
    t.symbol,
    t.type,
    t.quantity,
    t.price,
    t.commission,
    t.total_amount,
    t.timestamp,
    s.name
FROM transactions t
LEFT JOIN stock_cache s ON t.symbol = s.symbol
WHERE t.user_id = 1
ORDER BY t.timestamp DESC
LIMIT 50;
            </pre>

            <h4>ì „ì²´ ìì‚° ê³„ì‚°</h4>
            <pre>
SELECT 
    u.balance AS cash,
    COALESCE(SUM(p.quantity * s.current_price), 0) AS stock_value,
    u.balance + COALESCE(SUM(p.quantity * s.current_price), 0) AS total_assets
FROM users u
LEFT JOIN portfolios p ON u.id = p.user_id
LEFT JOIN stock_cache s ON p.symbol = s.symbol
WHERE u.id = 1
GROUP BY u.id, u.balance;
            </pre>
        </div>

        <div class="info-box">
            <h3>ğŸ¯ ë°ì´í„° ë¬´ê²°ì„± ì œì•½</h3>
            <ul>
                <li><strong>UNIQUE ì œì•½:</strong> email, username ì¤‘ë³µ ë¶ˆê°€</li>
                <li><strong>UNIQUE ì œì•½:</strong> (user_id, symbol) ì¡°í•© - ê°™ì€ ì¢…ëª© ì¤‘ë³µ ë³´ìœ  ë¶ˆê°€</li>
                <li><strong>CHECK ì œì•½:</strong> quantity > 0 (ìˆ˜ëŸ‰ì€ í•­ìƒ ì–‘ìˆ˜)</li>
                <li><strong>CHECK ì œì•½:</strong> type IN ('buy', 'sell') (ê±°ë˜ ìœ í˜• ì œí•œ)</li>
                <li><strong>CHECK ì œì•½:</strong> balance >= 0 (ì”ì•¡ ìŒìˆ˜ ë¶ˆê°€)</li>
                <li><strong>ON DELETE CASCADE:</strong> ì‚¬ìš©ì ì‚­ì œ ì‹œ ê´€ë ¨ ë°ì´í„° ìë™ ì‚­ì œ</li>
            </ul>
        </div>
    </div>

    <script>
        mermaid.initialize({ 
            startOnLoad: true,
            theme: 'default',
            themeVariables: {
                primaryColor: '#667eea',
                primaryTextColor: '#fff',
                primaryBorderColor: '#5568d3',
                lineColor: '#5568d3',
                secondaryColor: '#764ba2',
                tertiaryColor: '#f8f9fa'
            }
        });
    </script>
</body>
</html>
